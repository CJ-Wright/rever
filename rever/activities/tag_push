"""Activity for pushing tags."""
import re

from rever import vcsutils
from rever.activity import Activity
from rever.tools import eval_version


class TagPush(Activity):
    """Pushes the current tag up to a remote repository.

    This activity takes the following parameters:

    :$TAG_REMOTE: str or None, remote URL to push tags to. The default
        is None, which is only valid when push=False.
    :$TAG_TARGET: str or None, remote branch to push to once the tag has been made.
        The default is None, which uses the current branch.
    """

    def __init__(self, *, deps=frozenset(('tag', ))):
        super().__init__(name='tag', deps=deps, func=self._func,
                         desc="Tags the current version.")

    def _func(self, remote=None, target=None):
        if remote is None:
            raise ValueError('tag remote cannot be None to push up tags, '
                             'try setting $TAG_REMOTE in rever.xsh')
        if target is None:
            target = vcsutils.current_branch()
        vcsutils.push(remote, target)
        vcsutils.push_tags(remote)

    def undo(self):
        """Undoes the tagging operation."""
        kwargs = self.all_kwargs()
        template = kwargs.get('template', '$VERSION')
        push = kwargs.get('push', True)
        remote = kwargs.get('remote', None)
        tag = eval_version(template)
        if remote is None:
            raise ValueError('tag remote cannot be None to remove remote '
                             'tags, try setting $TAG_REMOTE in rever.xsh')
        vcsutils.del_remote_tag(tag, remote)
        msg = 'Removed remote tag {0!r}'.format(tag)
        log -a @(self.name) -c activity-undo @(msg)
